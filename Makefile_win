APP = hf.exe

OBJDIR = obj
BINDIR = bin

SRCS := src/bit_set.c src/code_tbl.c src/compress.c src/decompress.c src/hf.c src/io_code.c src/io_options.c src/node_t.c src/ppl.c src/ppl_heap.c src/ppl_tree.c src/wingetopt.c
SRCDIRS := src
OBJS := $(patsubst %.c,$(OBJDIR)/%.o,$(SRCS))
DEPS := $(patsubst %.c,$(OBJDIR)/%.d,$(SRCS))

DEBUG = -g -D _DEBUG_
INCLUDES = -I./include
CFLAGS = -std=c89 -pedantic -Wall -O3 $(INCLUDES) -c
LDFLAGS =
LIBS =

DEPENDS = -MT $@ -MD -MP -MF $(subst .o,.d,$@)

SHELL = /bin/bash

.PHONY: all doc run-tests test clean distclean

all: buildrepo $(APP)

$(APP): $(OBJS)
	$(CC) $(LDFLAGS) $^ $(LIBS) -o $(addprefix $(BINDIR)/, $@)

$(OBJDIR)/%.o: %.c
	$(CC) $(CFLAGS) $(DEPENDS) $< -o $@

clean:
	$(RM) -r $(OBJDIR)
	$(RM) $(shell find . -name '*~')
	$(RM) $(shell find . -name '.\#*')

distclean: clean
	$(RM) $(APP)

buildrepo:
	@$(call make-repo)

define make-repo
for dir in $(SRCDIRS); \
do \
mkdir -p $(OBJDIR)/$$dir; \
done
endef

ifneq "$(MAKECMDGOALS)" "distclean"
ifneq "$(MAKECMDGOALS)" "clean"
-include $(DEPS)
endif
endif

run-tests: all
	$(MAKE) -C tests

doc: 
	doxygen Doxyfile
